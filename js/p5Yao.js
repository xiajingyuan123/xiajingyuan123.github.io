let prompt_Guaxiang = ""; // 用于存储拼接后的提示词
let originalGuaName ="";
let changedGuaName ="";
let answerInLibrary = ""; 

const p5Yao = new P5DeepSeek();
//询问古籍是什么卦，以及古代的解释
function askLibrary() {
    // 拼接 prompt 的值
    CaculateYao(); // 计算爻变前后的数组
    prompt_Guaxiang = `卦象：${originalGuaName}，变卦：${changedGuaName}`;
    p5Yao.setSystemPrompt(`
        你是最古老的《周易》卦象分析师，
        我会给你一个卦名和变卦后的卦名，你需要查找古籍显示卦名对应的卦原文；
        需要简短，不需要具体解释每个爻！
        古籍原文需包含的内容的示例：
        “水雷屯卦像：上坎下震。屯卦木得天雨而沐之，或雷而交加，面对困难而思慎之像。坎为险，震为动，屯积、盈、物之始、聚顿挫，初始虽艰难，但不失其居处和立业。“以贵下溅，动於险中，忧患中深谋远虑。”坎为伸，则泄气无财，失脱。震为体且受生而获财升职。防肝病、衰血症，肾亏等，患在长男。”
        请返回一个JSON格式的对象，包含一个key：
        古籍原文（如果爻变，前后的原文都要写，如果未变卦，则只写一个）
        请严格按照以下格式{"古籍原文":}。`);
    p5Yao.send(prompt_Guaxiang);
    ifWaiting2 = true; // 设置等待状态
    p5Yao.onComplete = whenComplete2;
}

// 接收到GPT完整的消息时会调用的函数
function whenComplete2(text) {
    content = text.replace(/\n/g, ""); // 删去换行，以免格式错误
    const chineseCommaRegex = /(?<=":)\s*，|(?<=",)\s*(?=\s*[{])/g; // 可能误用中文逗号
    content = content.replace(chineseCommaRegex, ',');  
    content = content.match(/{[^{}]*}/); // 提取回答中的json格式
    jsonData = JSON.parse(content);
    answerInLibrary = jsonData["古籍原文"];
    console.log("卦象:", originalGuaName);
    console.log("变卦:", changedGuaName);
    console.log("古籍原文:", answerInLibrary);
    ifWaiting = false; // 重置等待状态
  }

  function displayLibraryAnswer(){
    const answerContainer2 = document.getElementById("libraryAnswerContainer");
    // 检查是否有最终解释
    if (answerInLibrary) {
        answerContainer2.innerText = `${answerInLibrary}`;
    } else {
        answerContainer2.innerText = "正在生成，请稍候...";
    }
  }

  function CaculateYao() {
    // 转化后的数组
    const transformedResults1 = originalResults.map(yaoArray => {
        const countOnes1 = yaoArray.filter(num => num === 1).length; // 统计 1 的数量
        const countZeros1 = yaoArray.filter(num => num === 0).length; // 统计 0 的数量
        return countOnes1 > countZeros1 ? 1 : 0; // 如果 1 比 0 多，返回 1；否则返回 0
    });
        // 转化后的数组
    const transformedResults2 = changedResults.map(yaoArray => {
        const countOnes2 = yaoArray.filter(num => num === 1).length; // 统计 1 的数量
        const countZeros2 = yaoArray.filter(num => num === 0).length; // 统计 0 的数量
        return countOnes2 > countZeros2 ? 1 : 0; // 如果 1 比 0 多，返回 1；否则返回 0
    });
    // 将转化后的数组存储到全局变量中
    originalResultsTransformed = transformedResults1;
    changedResultsTransformed = transformedResults2;
    originalGuaName = findGua(originalResultsTransformed); // 查找卦象
    changedGuaName = findGua(changedResultsTransformed); // 查找卦象
    console.log("转化后的数组1:", originalResultsTransformed);
    console.log("转化后的数组2:", changedResultsTransformed);
    
  }

  function findGua(codeArray) {
    const guaData = 
[
  {
    "卦符": "䷀",
    "编码": [1,1,1,1,1,1],
    "卦名": "乾为天",
    "序号": 1
  },
  {
    "卦符": "䷁",
    "编码": [0,0,0,0,0,0],
    "卦名": "坤为地",
    "序号": 2
  },
  {
    "卦符": "䷂",
    "编码": [1,0,0,0,1,0],
    "卦名": "水雷屯",
    "序号": 3
  },
  {
    "卦符": "䷃",
    "编码": [0,1,0,0,0,1],
    "卦名": "山水蒙",
    "序号": 4
  },
  {
    "卦符": "䷄",
    "编码": [1,1,1,0,1,0],
    "卦名": "水天需",
    "序号": 5
  },
  {
    "卦符": "䷅",
    "编码": [0,1,0,1,1,1],
    "卦名": "天水讼",
    "序号": 6
  },
  {
    "卦符": "䷆",
    "编码": [0,1,0,0,0,0],
    "卦名": "地水师",
    "序号": 7
  },
  {
    "卦符": "䷇",
    "编码": [0,0,0,0,1,0],
    "卦名": "水地比",
    "序号": 8
  },
  {
    "卦符": "䷈",
    "编码": [1,1,1,0,1,1],
    "卦名": "风天小畜",
    "序号": 9
  },
  {
    "卦符": "䷉",
    "编码": [1,1,0,1,1,1],
    "卦名": "天泽履",
    "序号": 10
  },
  {
    "卦符": "䷊",
    "编码": [1,1,1,0,0,0],
    "卦名": "天地泰",
    "序号": 11
  },
  {
    "卦符": "䷋",
    "编码": [0,0,0,1,1,1],
    "卦名": "地天否",
    "序号": 12
  },
  {
    "卦符": "䷌",
    "编码": [1,0,1,1,1,1],
    "卦名": "天火同人",
    "序号": 13
  },
  {
    "卦符": "䷍",
    "编码": [1,1,1,1,0,1],
    "卦名": "火天大有",
    "序号": 14
  },
  {
    "卦符": "䷎",
    "编码": [0,0,1,0,0,0],
    "卦名": "地山谦",
    "序号": 15
  },
  {
    "卦符": "䷏",
    "编码": [0,0,0,1,0,0],
    "卦名": "雷地豫",
    "序号": 16
  },
  {
    "卦符": "䷐",
    "编码": [1,0,0,1,1,0],
    "卦名": "泽雷随",
    "序号": 17
  },
  {
    "卦符": "䷑",
    "编码": [0,1,1,0,0,1],
    "卦名": "山风蛊",
    "序号": 18
  },
  {
    "卦符": "䷒",
    "编码": [1,1,0,0,0,0],
    "卦名": "地泽临",
    "序号": 19
  },
  {
    "卦符": "䷓",
    "编码": [0,0,0,0,1,1],
    "卦名": "风地观",
    "序号": 20
  },
  {
    "卦符": "䷔",
    "编码": [1,0,0,1,0,1],
    "卦名": "火雷噬嗑",
    "序号": 21
  },
  {
    "卦符": "䷕",
    "编码": [1,0,1,0,0,1],
    "卦名": "山火贲",
    "序号": 22
  },
  {
    "卦符": "䷖",
    "编码": [0,0,0,0,0,1],
    "卦名": "山地剥",
    "序号": 23
  },
  {
    "卦符": "䷗",
    "编码": [1,0,0,0,0,0],
    "卦名": "地雷复",
    "序号": 24
  },
  {
    "卦符": "䷘",
    "编码": [1,0,0,1,1,1],
    "卦名": "天雷无妄",
    "序号": 25
  },
  {
    "卦符": "䷙",
    "编码": [1,1,1,0,0,1],
    "卦名": "山天大畜",
    "序号": 26
  },
  {
    "卦符": "䷚",
    "编码": [1,0,0,0,0,1],
    "卦名": "山雷颐",
    "序号": 27
  },
  {
    "卦符": "䷛",
    "编码": [0,1,1,1,1,0],
    "卦名": "泽风大过",
    "序号": 28
  },
  {
    "卦符": "䷜",
    "编码": [0,1,0,0,1,0],
    "卦名": "坎为水",
    "序号": 29
  },
  {
    "卦符": "䷝",
    "编码": [1,0,1,1,0,1],
    "卦名": "离为火",
    "序号": 30
  },
  {
    "卦符": "䷞",
    "编码": [0,0,1,1,1,0],
    "卦名": "泽山咸",
    "序号": 31
  },
  {
    "卦符": "䷟",
    "编码": [0,1,1,1,0,0],
    "卦名": "雷风恒",
    "序号": 32
  },
  {
    "卦符": "䷠",
    "编码": [0,0,1,1,1,1],
    "卦名": "天山遁",
    "序号": 33
  },
  {
    "卦符": "䷡",
    "编码": [1,1,1,1,0,0],
    "卦名": "雷天大壮",
    "序号": 34
  },
  {
    "卦符": "䷢",
    "编码": [0,0,0,1,0,1],
    "卦名": "火地晋",
    "序号": 35
  },
  {
    "卦符": "䷣",
    "编码": [1,0,1,0,0,0],
    "卦名": "地火明夷",
    "序号": 36
  },
  {
    "卦符": "䷤",
    "编码": [1,0,1,0,1,1],
    "卦名": "风火家人",
    "序号": 37
  },
  {
    "卦符": "䷥",
    "编码": [1,1,0,1,0,1],
    "卦名": "火泽睽",
    "序号": 38
  },
  {
    "卦符": "䷦",
    "编码": [0,0,1,0,1,0],
    "卦名": "水山蹇",
    "序号": 39
  },
  {
    "卦符": "䷧",
    "编码": [0,1,0,1,0,0],
    "卦名": "雷水解",
    "序号": 40
  },
  {
    "卦符": "䷨",
    "编码": [1,1,0,0,0,1],
    "卦名": "山泽损",
    "序号": 41
  },
  {
    "卦符": "䷩",
    "编码": [1,0,0,0,1,1],
    "卦名": "风雷益",
    "序号": 42
  },
  {
    "卦符": "䷪",
    "编码": [1,1,1,1,1,0],
    "卦名": "泽天夬",
    "序号": 43
  },
  {
    "卦符": "䷫",
    "编码": [0,1,1,1,1,1],
    "卦名": "天风姤",
    "序号": 44
  },
  {
    "卦符": "䷬",
    "编码": [0,0,0,1,1,0],
    "卦名": "泽地萃",
    "序号": 45
  },
  {
    "卦符": "䷭",
    "编码": [0,1,1,0,0,0],
    "卦名": "地风升",
    "序号": 46
  },
  {
    "卦符": "䷮",
    "编码": [0,1,0,1,1,0],
    "卦名": "泽水困",
    "序号": 47
  },
  {
    "卦符": "䷯",
    "编码": [0,1,1,0,1,0],
    "卦名": "水风井",
    "序号": 48
  },
  {
    "卦符": "䷰",
    "编码": [1,0,1,1,1,0],
    "卦名": "泽火革",
    "序号": 49
  },
  {
    "卦符": "䷱",
    "编码": [0,1,1,1,0,1],
    "卦名": "火风鼎",
    "序号": 50
  },
  {
    "卦符": "䷲",
    "编码": [1,0,0,1,0,0],
    "卦名": "震为雷",
    "序号": 51
  },
  {
    "卦符": "䷳",
    "编码": [0,0,1,0,0,1],
    "卦名": "艮为山",
    "序号": 52
  },
  {
    "卦符": "䷴",
    "编码": [0,0,1,0,1,1],
    "卦名": "风山渐",
    "序号": 53
  },
  {
    "卦符": "䷵",
    "编码": [1,1,0,1,0,0],
    "卦名": "雷泽归妹",
    "序号": 54
  },
  {
    "卦符": "䷶",
    "编码": [1,0,1,1,0,0],
    "卦名": "雷火",
    "序号": 55
  },
  {
    "卦符": "䷷",
    "编码": [0,0,1,1,0,1],
    "卦名": "火山旅",
    "序号": 56
  },
  {
    "卦符": "䷸",
    "编码": [0,1,1,0,1,1],
    "卦名": "巽为风",
    "序号": 57
  },
  {
    "卦符": "䷹",
    "编码": [1,1,0,1,1,0],
    "卦名": "兑为泽",
    "序号": 58
  },
  {
    "卦符": "䷺",
    "编码": [0,1,0,0,1,1],
    "卦名": "风水涣",
    "序号": 59
  },
  {
    "卦符": "䷻",
    "编码": [1,1,0,0,1,0],
    "卦名": "水泽节",
    "序号": 60
  },
  {
    "卦符": "䷼",
    "编码": [1,1,0,0,1,1],
    "卦名": "风泽中孚",
    "序号": 61
  },
  {
    "卦符": "䷽",
    "编码": [0,0,1,1,0,0],
    "卦名": "雷山小过",
    "序号": 62
  },
  {
    "卦符": "䷾",
    "编码": [1,0,1,0,1,0],
    "卦名": "水火既济",
    "序号": 63
  },
  {
    "卦符": "䷿",
    "编码": [0,1,0,1,0,1],
    "卦名": "火水未济",
    "序号": 64
  }
]
    const codeStr = codeArray.join('');
    const gua = guaData.find(g => g.编码.join('') === codeStr);
    return gua ? gua.卦名 : "未变卦";
  }
  